nv.addGraph(function() {
  var chart = nv.models.pieChart()
        .x(function(d) { console.log(d); return d.label })
        .y(function(d) { return d.value })
        .showLabels(true);
  var data = {
    key: 'Ice Type',
    values: [] 
  };
  
  <%- grouped_ice_obs =  @cruise.observations.collect{|o| o.ice_observations}.flatten.map{|i| [i.ice_lookup.try(:name), i.partial_concentration]}.compact.inject(Hash.new(0)){|h,i| h[i.first] += [nil,0].include?(i.last) ? 0 : 1.0 / i.last; h}.as_json%>
  
  <%- grouped_ice_obs.each do |code, count| %>
    data.values.push({
      label: '<%= code %>',
      value: <%= count %>
    }); 
  <%- end %>
   
  var series = [data]; 
  
  d3.select("#<%= chart_id %> svg")
      .datum(series)
    .transition().duration(1200)
      .call(chart);
  
  return chart;
});